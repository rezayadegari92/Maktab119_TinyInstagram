<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Registration</h1>
    <div id="step1">
        <h2>Step 1: Register</h2>
        <form id="registerForm">
            {% csrf_token %}  <!-- CSRF token for registration form -->
            <input type="email" name="email" placeholder="Email" required><br>
            <input type="text" name="username" placeholder="Username" required><br>
            <input type="password" name="password" placeholder="Password" required><br>
            <input type="text" name="first_name" placeholder="First Name" required><br>
            <input type="text" name="last_name" placeholder="Last Name" required><br>
            <input type="date" name="birth_date" required><br>
            <input type="text" name="phone_number" placeholder="Phone Number"><br>
            <button type="submit">Register</button>
        </form>
    </div>

    <div id="step2" style="display:none;">
        <h2>Step 2: Verify OTP</h2>
        <form id="otpForm">
            {% csrf_token %}  <!-- CSRF token for OTP form -->
            <input type="hidden" name="email" id="otpEmail">
            <input type="hidden" name="username" id="otpUsername">
            <input type="hidden" name="password" id="otpPassword">
            <input type="hidden" name="first_name" id="otpFirstName">
            <input type="hidden" name="last_name" id="otpLastName">
            <input type="hidden" name="birth_date" id="otpBirthDate">
            <input type="hidden" name="phone_number" id="otpPhoneNumber">
            <input type="text" name="otp_code" placeholder="OTP Code" required><br>
            <button type="submit">Verify OTP</button>
        </form>
    </div>

    <div id="step3" style="display:none;">
        <h2>Step 3: Profile</h2>
        <div id="profileDetails">
            <p><strong>Username:</strong> <span id="profileUsername"></span></p>
            <p><strong>Website:</strong> <span id="profileWebsite">N/A</span></p>
            <p><strong>Bio:</strong> <span id="profileBio">N/A</span></p>
            <p><strong>Location:</strong> <span id="profileLocation">N/A</span></p>
            <p><strong>Private Account:</strong> <span id="profilePrivate">No</span></p>
            <p><strong>Profile Picture:</strong> <img id="profilePicture" src="" alt="Profile Picture" style="max-width: 100px; display: none;"></p>
            <div id="postsImages">
                <h3>Post Images</h3>
                <div id="postImagesList"></div>
            </div>
        </div>
        <h3>Complete Your Profile</h3>
        <form id="completeProfileForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" name="website" placeholder="Website"><br>
            <textarea name="bio" placeholder="Bio"></textarea><br>
            <input type="text" name="location" placeholder="Location"><br>
            <label>
            <input type="checkbox" name="is_private"> Private Account
            </label><br>
            <input type="file" name="profile_picture" accept="image/*"><br>
            <button type="submit">Save Profile</button>
            <button type="button" id="skipProfile">Skip</button>
        </form>
    </div>

    <script>
        // Function to get CSRF token from the form
        function getCSRFToken() {
            return $('input[name="csrfmiddlewaretoken"]').val();
        }

        $(document).ready(function () {
        let currentUserId = null;  // Store the current user ID

        // Step 1: Register and request OTP
        $('#registerForm').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: '/api/register/',
                method: 'POST',
                data: $(this).serialize(),
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function (response) {
                    $('#step1').hide();
                    $('#step2').show();
                    // Pre-fill hidden fields with registration data
                    $('#otpEmail').val($('#registerForm input[name="email"]').val());
                    $('#otpUsername').val($('#registerForm input[name="username"]').val());
                    $('#otpPassword').val($('#registerForm input[name="password"]').val());
                    $('#otpFirstName').val($('#registerForm input[name="first_name"]').val());
                    $('#otpLastName').val($('#registerForm input[name="last_name"]').val());
                    $('#otpBirthDate').val($('#registerForm input[name="birth_date"]').val());
                    $('#otpPhoneNumber').val($('#registerForm input[name="phone_number"]').val());
                },
                error: function (xhr, status, error) {
                    console.log("XHR:", xhr);
                    console.log("Status:", status);
                    console.log("Error:", error);
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "Registration failed. Please try again."));
                }
            });
        });

        // Step 2: Verify OTP and complete registration
        $('#otpForm').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: '/api/verify-otp/',
                method: 'POST',
                data: $(this).serialize(),
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function (response) {
                    console.log("User ID received:", response.user_id);
                    currentUserId = response.user_id;  // Store the user ID
                    $('#step2').hide();
                    $('#step3').show();
                    loadProfile(currentUserId);
                },
                error: function (xhr, status, error) {
                    console.log("XHR:", xhr);
                    console.log("Status:", status);
                    console.log("Error:", error);
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "OTP verification failed. Please try again."));
                }
            });
        });

        // Step 3: Load profile
        function loadProfile(userId) {
            $.ajax({
                url: '/api/profile/' + userId + '/',
                method: 'GET',
                success: function (response) {
                    $('#profileUsername').text(response.user);
                    $('#profileWebsite').text(response.website || 'N/A');
                    $('#profileBio').text(response.bio || 'N/A');
                    $('#profileLocation').text(response.location || 'N/A');
                    $('#profilePrivate').text(response.is_private ? 'Yes' : 'No');
                    if (response.profile_picture) {
                        $('#profilePicture').attr('src', response.profile_picture).show();
                    } else {
                        $('#profilePicture').hide();
                    }
                    // Display post images
                    const postImagesList = $('#postImagesList');
                    postImagesList.empty();
                    response.posts_images.forEach(imageUrl => {
                        if (imageUrl) {
                            postImagesList.append(`<img src="${imageUrl}" alt="Post Image" style="max-width: 100px; margin: 5px;">`);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.log("XHR:", xhr);
                    console.log("Status:", status);
                    console.log("Error:", error);
                    alert("Error loading profile. Please try again.");
                }
            });
        }

        // Complete Profile Form
        $('#completeProfileForm').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);  // Use FormData for file uploads
            console.log("Form Data:", formData);  // Log form data for debugging

            $.ajax({
                url: '/api/update-profile/' + currentUserId + '/',
                method: 'POST',
                data: formData,
                processData: false,  // Required for file uploads
                contentType: false,  // Required for file uploads
                headers: { "X-CSRFToken": getCSRFToken() },  // Include CSRF token
                success: function (response) {
                    alert("Profile updated successfully!");
                    loadProfile(currentUserId);  // Reload the profile
                },
                error: function (xhr, status, error) {
                    console.log("XHR:", xhr);
                    console.log("Status:", status);
                    console.log("Error:", error);
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "Failed to update profile."));
                }
            });
        });

        // Skip Profile
        $('#skipProfile').on('click', function () {
            alert("Profile setup skipped. You can update your profile later.");
            window.location.href = "/home/";  // Redirect to home page
        });
    });
    </script>
</body>
</html>